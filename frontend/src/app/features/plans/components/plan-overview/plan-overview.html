<div class="flex h-screen bg-slate-50 dark:bg-slate-900 overflow-hidden">
  
  <!-- Sidebar Navigation -->
  <aside class="w-64 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col z-20 shadow-xl">
    <!-- Header -->
    <div class="h-16 px-6 flex items-center border-b border-slate-200 dark:border-slate-700 bg-white/50 dark:bg-slate-800/50 backdrop-blur-md">
      <div class="flex items-center gap-3 w-full">
        <button 
          [routerLink]="['/projects', projectStore.selectedProject()?.id]"
          class="p-2 -ml-2 rounded-lg text-slate-400 hover:text-primary hover:bg-slate-100 dark:hover:bg-slate-700 transition-all"
        >
          <span class="material-symbols-outlined">arrow_back</span>
        </button>
        <span class="font-bold text-slate-800 dark:text-white truncate">Plan Overview</span>
      </div>
    </div>

    <!-- Navigation List -->
    <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-2">
      <div class="px-2 pb-4">
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Overall Progress</span>
          <span class="text-xs font-bold text-primary">{{ overallProgress() }}%</span>
        </div>
        <div class="h-2 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
          <div class="h-full bg-primary transition-all duration-1000" [style.width.%]="overallProgress()"></div>
        </div>
      </div>

      <div class="space-y-1">
        @for (epic of epics(); track epic.id) {
          <button 
            (click)="scrollToEpic(epic.id)"
            class="w-full text-left px-4 py-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-all group relative overflow-hidden"
          >
            <div class="flex items-center justify-between mb-1 relative z-10">
              <span class="text-sm font-semibold text-slate-700 dark:text-slate-200 group-hover:text-primary truncate">{{ epic.title }}</span>
            </div>
            <div class="flex items-center gap-2 relative z-10">
              <span class="w-1.5 h-1.5 rounded-full" 
                [class.bg-slate-300]="epic.status === 'TODO'"
                [class.bg-blue-500]="epic.status === 'IN_PROGRESS'"
                [class.bg-green-500]="epic.status === 'DONE'"
              ></span>
              <span class="text-[10px] text-slate-400">{{ getEpicProgress(epic) }}%</span>
            </div>
            <!-- Progress Overlay -->
            <div class="absolute bottom-0 left-0 h-0.5 bg-primary/20 transition-all" [style.width.%]="getEpicProgress(epic)"></div>
          </button>
        }
        
        <button 
          (click)="openCreateModal('epic')"
          class="w-full mt-4 border border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-3 flex items-center justify-center gap-2 text-slate-400 hover:text-primary hover:border-primary hover:bg-primary/5 transition-all group"
        >
          <span class="material-symbols-outlined text-lg group-hover:scale-110 transition-transform">add</span>
          <span class="text-xs font-bold">New Epic</span>
        </button>
      </div>
    </div>
  </aside>

  <!-- Main Content Area -->
  <main class="flex-1 flex flex-col h-full overflow-hidden relative">
    <div class="flex-1 overflow-y-auto scroll-smooth p-8 pb-32" id="main-content">
      <div class="max-w-[1600px] mx-auto space-y-12">
        
        @for (epic of epics(); track epic.id) {
          <section [id]="'epic-' + epic.id" class="space-y-6 scroll-mt-8">
            <!-- Epic Header Section -->
            <div class="bg-white dark:bg-slate-800 rounded-3xl p-8 border border-slate-200 dark:border-slate-700 shadow-sm relative overflow-hidden group">
              <div class="absolute top-0 left-0 w-2 h-full" 
                [class.bg-slate-300]="epic.status === 'TODO'"
                [class.bg-blue-500]="epic.status === 'IN_PROGRESS'"
                [class.bg-green-500]="epic.status === 'DONE'"
              ></div>
              
              <div class="flex justify-between items-start relative z-10">
                <div class="flex-1 max-w-4xl">
                  <div class="flex items-center gap-3 mb-3">
                    <span class="px-3 py-1 bg-slate-100 dark:bg-slate-700 rounded-lg text-xs font-bold text-slate-500 uppercase tracking-wider">Epic</span>
                    <span 
                      class="px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-wider"
                      [class.bg-red-100.text-red-700.dark:bg-red-900/30.dark:text-red-400]="epic.priority === 'HIGH'"
                      [class.bg-yellow-100.text-yellow-700.dark:bg-yellow-900/30.dark:text-yellow-400]="epic.priority === 'MEDIUM'"
                      [class.bg-green-100.text-green-700.dark:bg-green-900/30.dark:text-green-400]="epic.priority === 'LOW'"
                    >
                      {{ epic.priority }} Priority
                    </span>
                    <span 
                      class="px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-wider"
                      [class.bg-slate-100.text-slate-600.dark:bg-slate-700.dark:text-slate-300]="epic.status === 'TODO'"
                      [class.bg-blue-100.text-blue-700.dark:bg-blue-900/30.dark:text-blue-400]="epic.status === 'IN_PROGRESS'"
                      [class.bg-green-100.text-green-700.dark:bg-green-900/30.dark:text-green-400]="epic.status === 'DONE'"
                    >
                      {{ epic.status.replace('_', ' ') }}
                    </span>
                  </div>
                  <h2 class="text-3xl font-extrabold text-slate-900 dark:text-white mb-4 tracking-tight">{{ epic.title }}</h2>
                  <p class="text-lg text-slate-600 dark:text-slate-300 leading-relaxed">{{ epic.description }}</p>
                </div>
                
                <div class="flex flex-col gap-3">
                  <button 
                    (click)="openEditModal('epic', epic)"
                    class="size-10 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-primary hover:bg-primary/10 transition-all flex items-center justify-center"
                  >
                    <span class="material-symbols-outlined">edit</span>
                  </button>
                  <button 
                    (click)="openCreateModal('story', epic.id)"
                    class="px-4 py-2 bg-primary text-white rounded-xl text-sm font-bold shadow-lg shadow-primary/20 hover:bg-primary/90 transition-all flex items-center gap-2"
                  >
                    <span class="material-symbols-outlined text-lg">add</span>
                    Add Story
                  </button>
                </div>
              </div>
            </div>

            <!-- Stories Grid -->
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
              @for (story of epic.stories; track story.id) {
                <div class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm hover:shadow-md hover:border-primary/30 transition-all flex flex-col h-full group/story">
                  <!-- Story Header -->
                  <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                      <div class="flex items-center gap-2 mb-2">
                        <span class="material-symbols-outlined text-primary text-lg">article</span>
                        <span 
                          class="text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded"
                          [class.bg-red-50.text-red-600.dark:bg-red-900/20.dark:text-red-400]="story.priority === 'HIGH'"
                          [class.bg-yellow-50.text-yellow-600.dark:bg-yellow-900/20.dark:text-yellow-400]="story.priority === 'MEDIUM'"
                          [class.bg-green-50.text-green-600.dark:bg-green-900/20.dark:text-green-400]="story.priority === 'LOW'"
                        >{{ story.priority }}</span>
                      </div>
                      <h3 class="text-lg font-bold text-slate-900 dark:text-white leading-tight group-hover/story:text-primary transition-colors">{{ story.title }}</h3>
                    </div>
                    <button 
                      (click)="openEditModal('story', story)"
                      class="opacity-0 group-hover/story:opacity-100 p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg text-slate-400 hover:text-primary transition-all"
                    >
                      <span class="material-symbols-outlined text-base">edit</span>
                    </button>
                  </div>

                  <!-- Narrative -->
                  <div class="bg-slate-50 dark:bg-slate-900/50 rounded-xl p-4 mb-6 border border-slate-100 dark:border-slate-800">
                    <div class="space-y-2 text-sm text-slate-700 dark:text-slate-300">
                      @if (story.asA) {
                        <div class="flex gap-2">
                          <span class="text-slate-400 dark:text-slate-500 font-bold uppercase text-[10px] min-w-[3rem] pt-0.5">As a</span>
                          <span>{{ story.asA }}</span>
                        </div>
                      }
                      @if (story.iWant) {
                        <div class="flex gap-2">
                          <span class="text-slate-400 dark:text-slate-500 font-bold uppercase text-[10px] min-w-[3rem] pt-0.5">I want</span>
                          <span>{{ story.iWant }}</span>
                        </div>
                      }
                      @if (story.soThat) {
                        <div class="flex gap-2">
                          <span class="text-slate-400 dark:text-slate-500 font-bold uppercase text-[10px] min-w-[3rem] pt-0.5">So that</span>
                          <span>{{ story.soThat }}</span>
                        </div>
                      }
                    </div>
                  </div>

                  <!-- Tasks List -->
                  <div class="flex-1">
                    <div class="flex items-center justify-between mb-3">
                      <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                        Tasks
                        <span class="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-1.5 py-0.5 rounded text-[10px]">{{ story.tasks.length }}</span>
                      </h4>
                      <button 
                        (click)="openCreateModal('task', story.id)"
                        class="text-xs font-bold text-primary hover:underline flex items-center gap-1"
                      >
                        <span class="material-symbols-outlined text-sm">add</span>
                        Add Task
                      </button>
                    </div>

                    <div class="space-y-2">
                      @for (task of story.tasks; track task.id) {
                        <div class="group/task flex items-start gap-3 p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors cursor-pointer" (click)="openEditModal('task', task)">
                          <span 
                            class="material-symbols-outlined text-base mt-0.5" 
                            [class.text-green-500]="task.status === 'DONE'"
                            [class.text-slate-300]="task.status !== 'DONE'"
                          >
                            {{ task.status === 'DONE' ? 'check_circle' : 'radio_button_unchecked' }}
                          </span>
                          <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-slate-700 dark:text-slate-300 truncate" [class.line-through]="task.status === 'DONE' && 'text-slate-400'">
                              {{ task.title }}
                            </p>
                            @if (task.description) {
                                <p class="text-xs text-slate-400 truncate">{{ task.description }}</p>
                            }
                          </div>
                          <div class="flex items-center gap-2">
                            @if (task.estimatedHours) {
                              <span class="text-[10px] font-bold text-slate-400 flex items-center gap-0.5 bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded">
                                <span class="material-symbols-outlined text-[10px]">schedule</span>
                                {{ task.estimatedHours }}h
                              </span>
                            }
                            <span 
                                class="text-[9px] font-bold uppercase tracking-wider px-1.5 py-0.5 rounded"
                                [class.bg-green-50.text-green-600]="task.status === 'DONE'"
                                [class.bg-blue-50.text-blue-600]="task.status === 'IN_PROGRESS'"
                                [class.bg-slate-100.text-slate-500]="task.status === 'TODO'"
                            >
                                {{ task.status === 'IN_PROGRESS' ? 'WIP' : task.status }}
                            </span>
                          </div>
                        </div>
                      } @empty {
                        <div class="text-center py-4 border-2 border-dashed border-slate-100 dark:border-slate-800 rounded-xl">
                          <p class="text-xs text-slate-400">No tasks yet</p>
                        </div>
                      }
                    </div>
                  </div>
                </div>
              } @empty {
                <div class="col-span-full py-12 flex flex-col items-center justify-center text-slate-400 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-3xl bg-slate-50/50 dark:bg-slate-800/30">
                  <span class="material-symbols-outlined text-4xl mb-2">content_paste_off</span>
                  <p class="font-medium">No stories defined for this epic yet.</p>
                  <button (click)="openCreateModal('story', epic.id)" class="mt-4 text-primary font-bold hover:underline">Create First Story</button>
                </div>
              }
            </div>
          </section>
        } @empty {
          <div class="flex flex-col items-center justify-center h-[60vh] text-slate-400">
            <div class="size-24 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center mb-6">
              <span class="material-symbols-outlined text-5xl text-slate-300">folder_off</span>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-2">Your Plan is Empty</h2>
            <p class="max-w-md text-center mb-8">Start by chatting with the AI to generate a plan, or create your first Epic manually.</p>
            <button 
              (click)="openCreateModal('epic')"
              class="px-8 py-4 bg-primary text-white rounded-2xl font-bold text-lg shadow-xl shadow-primary/20 hover:scale-105 transition-all"
            >
              Create Epic
            </button>
          </div>
        }
      </div>
    </div>
  </main>
</div>

<!-- Edit Modal -->
@if (editModalData()) {
  <app-item-edit-modal
    [data]="editModalData()"
    (close)="closeEditModal()"
    (save)="onSaveItem($event)"
    (delete)="onDeleteItem($event)"
  />
}
