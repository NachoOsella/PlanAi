<div class="h-full flex flex-col relative bg-slate-50 dark:bg-slate-900">
  
  <!-- Messages Area -->
  <div class="flex-1 overflow-y-auto custom-scrollbar p-4 lg:p-8 pb-32 lg:pb-36 space-y-8" #messagesContainer role="log" aria-live="polite" aria-label="Chat messages">
    @for (message of chatStore.messages(); track trackByMessageId($index, message)) {
      <div 
        class="flex w-full message-enter" 
        [class.justify-end]="message.role === 'USER'"
        [class.justify-start]="message.role === 'ASSISTANT'"
      >
        <div class="flex gap-3 max-w-[85%] lg:max-w-[75%]" [class.flex-row-reverse]="message.role === 'USER'">
          
          <!-- Avatar (Only for Assistant) -->
          @if (message.role === 'ASSISTANT') {
            <div class="size-8 rounded-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 flex items-center justify-center shrink-0 shadow-sm mt-1">
              <span class="material-symbols-outlined text-base text-primary" aria-hidden="true">smart_toy</span>
            </div>
          }

          <!-- Message Bubble -->
          <div class="flex flex-col gap-1" [class.items-end]="message.role === 'USER'">
            @if (message.role === 'ASSISTANT') {
              <span class="text-[10px] font-bold text-slate-400 ml-1">PlanAI</span>
            }
            
            <div 
              class="py-3 px-5 rounded-2xl text-sm leading-relaxed shadow-sm"
              [class.bg-primary.text-white.rounded-tr-sm]="message.role === 'USER'"
              [class.bg-white.dark:bg-slate-800.text-slate-700.dark:text-slate-300.border.border-slate-200.dark:border-slate-700.rounded-tl-sm]="message.role === 'ASSISTANT'"
            >
              <!-- Markdown rendered content -->
              <div 
                class="prose prose-sm max-w-none dark:prose-invert prose-p:my-1 prose-ul:my-1 prose-ol:my-1 prose-li:my-0 prose-headings:my-2"
                [class.text-white.prose-headings:text-white.prose-strong:text-white.prose-code:text-white]="message.role === 'USER'"
                [innerHTML]="message.content | markdown"
              ></div>
            </div>
          </div>
        </div>
      </div>
    } @empty {
      <div class="h-full flex flex-col items-center justify-center text-center p-8 opacity-0 animate-[messageSlideIn_0.5s_ease-out_forwards]">
        <div class="size-20 rounded-3xl bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center mb-6 shadow-inner">
          <span class="material-symbols-outlined text-4xl text-primary" aria-hidden="true">auto_awesome</span>
        </div>
        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-3">How can I help plan today?</h3>
        <p class="text-sm text-slate-500 max-w-sm leading-relaxed">
          I can help you structure your project, create epics, write user stories, or break down tasks. Just ask!
        </p>
      </div>
    }

    <!-- Loading Indicator -->
    @if (chatStore.sending()) {
      <div class="flex w-full justify-start message-enter">
        <div class="flex gap-3 max-w-[85%]">
          <div class="size-8 rounded-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 flex items-center justify-center shrink-0 shadow-sm mt-1">
            <span class="material-symbols-outlined text-base text-primary animate-pulse" aria-hidden="true">smart_toy</span>
          </div>
          <div class="flex flex-col gap-1">
            <span class="text-[10px] font-bold text-slate-400 ml-1">PlanAI</span>
            <div class="py-3 px-5 rounded-2xl rounded-tl-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm">
              <div class="flex gap-1.5 items-center h-5">
                <div class="size-1.5 bg-slate-400 rounded-full animate-bounce [animation-delay:-0.3s]"></div>
                <div class="size-1.5 bg-slate-400 rounded-full animate-bounce [animation-delay:-0.15s]"></div>
                <div class="size-1.5 bg-slate-400 rounded-full animate-bounce"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Input Area (Fixed Bottom) -->
  <div class="p-4 lg:p-6 border-t border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md absolute bottom-0 left-0 right-0 z-10">
    <div class="max-w-3xl mx-auto relative">
      <label for="chat-input" class="sr-only">Type a command or ask to change the plan</label>
      <textarea 
        id="chat-input"
        #chatTextarea
        class="w-full min-h-[56px] max-h-[150px] bg-white dark:bg-slate-800 border-none rounded-2xl pl-12 lg:pl-14 pr-14 py-4 shadow-lg shadow-slate-200/50 dark:shadow-none ring-1 ring-slate-200 dark:ring-slate-700 focus:ring-2 focus:ring-primary transition-all text-sm font-medium resize-none overflow-y-auto custom-scrollbar" 
        placeholder="Type a command or ask to change the plan..." 
        rows="1"
        [value]="inputValue()"
        [disabled]="chatStore.sending()"
        (input)="onInputChange($event)"
        (keydown)="onKeyDown($event)"
      ></textarea>
      
      <div class="absolute left-3 lg:left-4 top-4 flex items-center gap-2 pointer-events-none">
        <div class="size-7 lg:size-8 rounded-lg bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-slate-400">
          <span class="material-symbols-outlined text-lg lg:text-xl" aria-hidden="true">terminal</span>
        </div>
      </div>

      <div class="absolute right-3 top-3 flex items-center gap-2">
        <button 
          class="size-9 rounded-xl bg-primary text-white flex items-center justify-center hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-md shadow-primary/20"
          [disabled]="chatStore.sending() || !inputValue().trim()"
          (click)="sendMessage()"
          aria-label="Send message"
        >
          <span class="material-symbols-outlined text-xl" aria-hidden="true">arrow_upward</span>
        </button>
      </div>
    </div>
    <p class="text-center text-[10px] text-slate-400 mt-3 font-medium uppercase tracking-widest">Press Enter to send, Shift+Enter for new line</p>
  </div>
</div>
